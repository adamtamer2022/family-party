<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة تحكم برنامج الحفلة (Admin)</title>
  <style>
    :root{--bg:#0f1116;--card:#151a23;--muted:#9097a6;--accent:#35c27e;--danger:#ff4d4f;--warn:#ffb020;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6e9ef}
    header{padding:16px 20px;border-bottom:1px solid #1f2633;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .cfg{font-size:12px;color:var(--muted)}
    main{max-width:1000px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2633;border-radius:12px;padding:16px;margin-bottom:16px}
    label{display:block;margin:0 0 6px 0;color:#cbd2e1;font-size:13px}
    input,select,button{font:inherit}
    input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3242;background:#0f1218;color:#e6e9ef;outline:none}
    .row{display:grid;grid-template-columns:1fr 140px 140px;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr;gap:8px;margin-top:10px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #2a3242;background:#0f1218;color:#e6e9ef;cursor:pointer}
    .btn:hover{filter:brightness(1.15)}
    .btn.accent{background:linear-gradient(135deg,#1e9f6e,#35c27e);border:none;color:#06130f}
    .btn.warn{background:#221a07;border:1px solid #3a2b07;color:#ffcf6b}
    .btn.danger{background:#2a1313;border:1px solid #3a1a1a;color:#ffb3b3}
    .list .item{display:grid;grid-template-columns:56px 1fr 200px 420px;gap:10px;align-items:center;padding:10px;border-bottom:1px dashed #263044}
    .chip{padding:4px 8px;border-radius:20px;font-size:12px;border:1px solid #2a3242;color:#cfd6e6;background:#0f1218;text-align:center}
    .chip.active{background:rgba(53,194,126,.15);border-color:#1f8a5b;color:#9defc8}
    .chip.done{background:rgba(255,77,79,.15);border-color:#6a1b1c;color:#ffb4b5}
    .chip.paused{background:rgba(255,176,32,.15);border-color:#7a5211;color:#ffd892}
    .muted{color:var(--muted);font-size:12px}
    .title{font-weight:600}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    .small{font-size:12px}
    .footer{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:980px){
      .row{grid-template-columns:1fr 120px 120px}
      .list .item{grid-template-columns:40px 1fr 170px 1fr}
      .row2{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <h1>🎬 لوحة تحكم برنامج الحفلة</h1>
  </header>

  <main>
    <section class="card">
      <h3 style="margin-top:0">➕ إضافة فقرة جديدة</h3>
      <div class="row">
        <div>
          <label>اسم الفقرة</label>
          <input id="title" type="text" placeholder="مثال: الافتتاح / لعبة الكنز / فقرة الجوائز"/>
        </div>
        <div>
          <label>المدة (دقائق)</label>
          <input id="mins" type="number" min="1" step="1" value="10"/>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button id="addBtn" class="btn accent" title="Add">إضافة</button>
        </div>
      </div>
      <div class="hint">بعد الإضافة يمكنك تشغيل/إيقاف/تمديد الوقت أو تعديل/حذف الفقرة من القائمة بالأسفل.</div>
    </section>

    <section class="card">
      <div class="footer">
        <button id="clearAll" class="btn danger">حذف جميع الفقرات</button>
        <button id="sortAlpha" class="btn">ترتيب أبجدي</button>
        <button id="sortManual" class="btn">إعادة الترتيب اليدوي</button>
        <span class="muted">اسحب ↕️ الأيقونة لتحريك الفقرة عند الترتيب اليدوي</span>
      </div>
    </section>

    <section class="card list">
      <div class="item" style="opacity:.7">
        <div class="muted">#</div>
        <div class="muted">الفقرة</div>
        <div class="muted">الحالة</div>
        <div class="muted">التحكم</div>
      </div>
      <div id="list"></div>
    </section>
  </main>

  <!-- Firebase SDK (Compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ====== 1) ضع إعدادات Firebase هنا ======
  const firebaseConfig = {
    apiKey: "AIzaSyAVzRmVlUcyXsg25KM26_wJs-QMuF52k2o",
    authDomain: "frist-3a4ee.firebaseapp.com",
    databaseURL: "https://frist-3a4ee-default-rtdb.firebaseio.com",
    projectId: "frist-3a4ee",
    storageBucket: "frist-3a4ee.appspot.com",
    messagingSenderId: "1098758189245",
    appId: "1:1098758189245:web:dddd9e453767b7629387d4",
    measurementId: "G-K9JNSJPXXN"
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const refSessions = db.ref('program/sessions');

    // ====== Helpers ======
    const byId = (id)=>document.getElementById(id);
    const fmt = (s)=>{
      s = Math.max(0, Math.floor(s));
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      if(h>0) return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
      return `${m}:${String(sec).padStart(2,'0')}`;
    };
    const now = ()=>Date.now();

    // ====== Add session ======
    byId('addBtn').onclick = async ()=>{
      const title = byId('title').value.trim();
      const mins = parseInt(byId('mins').value || '0', 10);
      if(!title || mins<=0){ alert('اكتب اسم الفقرة وحدد مدة صحيحة'); return; }
      const key = refSessions.push().key;
      const order = now();
      await refSessions.child(key).set({
        id:key, title, durationSec: mins*60, remainingSec: mins*60,
        status:'upcoming', createdAt: now(), startedAt: null, endsAt: null,
        pausedAt:null, order
      });
      byId('title').value = ''; byId('mins').value = 10;
    };

    // ====== Sorting controls ======
    byId('clearAll').onclick = async ()=>{
      if(confirm('هل تريد حذف كل الفقرات؟')) await refSessions.remove();
    };
    byId('sortAlpha').onclick = async ()=>{
      const snap = await refSessions.get();
      if(!snap.exists()) return;
      const arr = Object.values(snap.val()).sort((a,b)=> a.title.localeCompare(b.title,'ar'));
      const updates = {};
      arr.forEach((s,i)=> updates[s.id+'/order'] = 1000+i);
      await refSessions.update(updates);
    };
    byId('sortManual').onclick = ()=>{
      document.querySelectorAll('.drag').forEach(el=> el.draggable = true);
      alert('اسحب رمز ↕️ يمين كل عنصر لتحريكه لأعلى/لأسفل.');
    };

    // ====== Render list and live controls ======
    const list = byId('list');

    refSessions.orderByChild('order').on('value', (snap)=>{
      list.innerHTML = '';
      const data = snap.val() || {};
      const items = Object.values(data).sort((a,b)=> (a.order||0)-(b.order||0));
      items.forEach(renderItem);
    });

    function renderItem(s){
      const row = document.createElement('div');
      row.className = 'item';
      row.dataset.id = s.id;

      // Drag handle
      const handle = document.createElement('div');
      handle.textContent = '↕️';
      handle.className = 'drag chip';
      handle.style.cursor='grab';
      handle.title='اسحب لإعادة الترتيب';
      handle.draggable = true;

      handle.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/plain', s.id);
      });
      row.addEventListener('dragover', (e)=> e.preventDefault());
      row.addEventListener('drop', async (e)=>{
        e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        if(!draggedId || draggedId === s.id) return;
        const rows = Array.from(list.children);
        const targetIndex = rows.indexOf(row);
        const draggedEl = rows.find(r=> r.dataset.id===draggedId);
        const draggedIndex = rows.indexOf(draggedEl);
        // swap orders
        const aId = rows[targetIndex].dataset.id;
        const bId = rows[draggedIndex].dataset.id;
        const aOrder = parseInt(rows[targetIndex].dataset.order||0,10);
        const bOrder = parseInt(rows[draggedIndex].dataset.order||0,10);
        const updates = {};
        updates[`${aId}/order`] = bOrder || (now()+targetIndex);
        updates[`${bId}/order`] = aOrder || (now()+draggedIndex);
        await refSessions.update(updates);
      });

      // Title + meta
      const title = document.createElement('div');
      title.innerHTML = `<div class="title">${s.title||''}</div>
                         <div class="muted small">
                           المدة الأصلية: ${Math.round((s.durationSec||0)/60)} دقيقة
                           &nbsp;|&nbsp; متبقي: ${fmt(s.remainingSec||0)}
                         </div>`;

      // Status chip
      const st = document.createElement('div');
      const chip = document.createElement('div');
      chip.className = 'chip ' + (s.status==='active'?'active': s.status==='done'?'done': s.status==='paused'?'paused':'');
      chip.textContent = s.status==='active'?'قيد التنفيذ': s.status==='done'?'انتهت': s.status==='paused'?'متوقفة':'قادمة';
      st.appendChild(chip);

      // Controls
      const ctr = document.createElement('div');
      ctr.className = 'controls';
      const mkBtn = (txt, cls, cb)=>{
        const b = document.createElement('button'); b.className = 'btn '+(cls||''); b.textContent=txt; b.onclick=cb; return b;
      };

      const start = mkBtn('▶️ بدء','accent', async ()=>{
        const snap = await refSessions.child(s.id).get();
        const ss = snap.val();
        const rem = (ss && ss.remainingSec!=null)? ss.remainingSec : ss.durationSec;
        const startedAt = now();
        await refSessions.child(s.id).update({ status:'active', startedAt, endsAt: startedAt + rem*1000 });
      });

      const pause = mkBtn('⏸️ إيقاف مؤقت','warn', async ()=>{
        const snap = await refSessions.child(s.id).get();
        const ss = snap.val(); if(!ss) return;
        let rem = ss.remainingSec;
        if(ss.status==='active' && ss.endsAt){
          rem = Math.max(0, Math.floor((ss.endsAt - now())/1000));
        }
        await refSessions.child(s.id).update({ status:'paused', pausedAt: now(), remainingSec: rem, endsAt: null });
      });

      const resume = mkBtn('⏵️ استئناف','accent', async ()=>{
        const snap = await refSessions.child(s.id).get();
        const ss = snap.val(); if(!ss) return;
        const rem = Math.max(1, ss.remainingSec||ss.durationSec);
        const startedAt = now();
        await refSessions.child(s.id).update({ status:'active', startedAt, endsAt: startedAt + rem*1000 });
      });

      const extend = mkBtn('+5 دقائق','', async ()=>{
        const snap = await refSessions.child(s.id).get();
        const ss = snap.val(); if(!ss) return;
        let rem = ss.remainingSec || Math.max(0, Math.floor((ss.endsAt? ss.endsAt - now():0)/1000));
        if(ss.status==='active' && ss.endsAt){
          rem = Math.max(0, Math.floor((ss.endsAt - now())/1000));
        }
        rem = Math.max(0, rem) + (5*60);
        const startedAt = now();
        await refSessions.child(s.id).update({
          status:'active', startedAt, remainingSec: rem, endsAt: startedAt + rem*1000
        });
      });

      const end = mkBtn('⏹️ إنهاء','danger', async ()=>{
        await refSessions.child(s.id).update({ status:'done', remainingSec:0, endsAt: now() });
      });

      const del = mkBtn('🗑️ حذف','danger', async ()=>{
        if(confirm('حذف الفقرة؟')) await refSessions.child(s.id).remove();
      });

      const edit = mkBtn('✏️ تعديل','', async ()=>{
        const newTitle = prompt('اسم الفقرة', s.title||'');
        if(!newTitle) return;
        const newMins = parseInt(prompt('المدة (بالدقائق)', Math.round((s.durationSec||0)/60)) || '0',10);
        if(!(newMins>0)) return;
        const newDur = newMins*60;
        let newRem = newDur;
        if(s.status!=='upcoming') newRem = s.remainingSec || newDur;
        await refSessions.child(s.id).update({ title:newTitle, durationSec:newDur, remainingSec:newRem });
      });

      const up = mkBtn('⬆️','', async ()=>{
        await refSessions.child(s.id).update({ order: (s.order||now()) - 1 });
      });
      const down = mkBtn('⬇️','', async ()=>{
        await refSessions.child(s.id).update({ order: (s.order||now()) + 1 });
      });

      ctr.append(start,pause,resume,extend,end,edit,del,up,down);

      row.append(handle,title,st,ctr);
      row.dataset.order = s.order||0;
      list.appendChild(row);
    }
  </script>
</body>
</html>
